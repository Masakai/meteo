# 流星検出 Docker Compose設定（Webプレビュー付き）
# 自動生成: python generate_compose.py
#
# Copyright (c) 2026 Masanori Sakai
# All rights reserved.
#
# 使い方:
#   起動:     docker compose up -d
#   停止:     docker compose down
#   ログ確認: docker compose logs -f
#
# Webプレビュー:
#   http://localhost:8080/  (ダッシュボード)
#   http://localhost:8081/  (カメラ1: 10.0.1.25)
#   http://localhost:8082/  (カメラ2: 10.0.1.3)
#   http://localhost:8083/  (カメラ3: 10.0.1.11)
#
# 検出結果は ./detections/ 以下に保存されます

services:
  # ダッシュボード（全カメラ一覧）
  dashboard:
    build:
      context: .
      dockerfile: Dockerfile.dashboard
    container_name: meteor-dashboard
    restart: unless-stopped
    environment:
      - TZ=Asia/Tokyo
      - PORT=8080
      - LATITUDE=35.3606
      - LONGITUDE=138.7274
      - TIMEZONE=Asia/Tokyo
      - ENABLE_TIME_WINDOW=true
      - CAMERA1_NAME=camera1 (10.0.1.25)
      - CAMERA1_URL=http://localhost:8081
      - CAMERA2_NAME=camera2 (10.0.1.3)
      - CAMERA2_URL=http://localhost:8082
      - CAMERA3_NAME=camera3 (10.0.1.11)
      - CAMERA3_URL=http://localhost:8083
    ports:
      - "8080:8080"
    volumes:
      - ./detections:/output:ro
    networks:
      - meteor-net
    depends_on:
      - camera1
      - camera2
      - camera3

  # カメラ1 (10.0.1.25)
  camera1:
    build:
      context: .
      args:
        MASK_IMAGE: masks/camera1_mask.png
    container_name: meteor-camera1
    restart: unless-stopped
    environment:
      - TZ=Asia/Tokyo
      - RTSP_URL=rtsp://6199:4003@10.0.1.25/live
      - CAMERA_NAME=camera1_10_0_1_25
      - SENSITIVITY=medium
      - SCALE=0.5
      - BUFFER=15
      - EXCLUDE_BOTTOM=0.0625
      - EXTRACT_CLIPS=true
      - LATITUDE=35.3606
      - LONGITUDE=138.7274
      - TIMEZONE=Asia/Tokyo
      - ENABLE_TIME_WINDOW=true
      - MASK_IMAGE=/app/mask_image.png
      - MASK_DILATE=5
      - MASK_SAVE=
      - WEB_PORT=8080
    ports:
      - "8081:8080"
    volumes:
      - ./detections:/output
    networks:
      - meteor-net
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # カメラ2 (10.0.1.3)
  camera2:
    build:
      context: .
      args:
        MASK_IMAGE: masks/camera2_mask.png
    container_name: meteor-camera2
    restart: unless-stopped
    environment:
      - TZ=Asia/Tokyo
      - RTSP_URL=rtsp://6199:4003@10.0.1.3/live
      - CAMERA_NAME=camera2_10_0_1_3
      - SENSITIVITY=medium
      - SCALE=0.5
      - BUFFER=15
      - EXCLUDE_BOTTOM=0.0625
      - EXTRACT_CLIPS=true
      - LATITUDE=35.3606
      - LONGITUDE=138.7274
      - TIMEZONE=Asia/Tokyo
      - ENABLE_TIME_WINDOW=true
      - MASK_IMAGE=/app/mask_image.png
      - MASK_DILATE=5
      - MASK_SAVE=
      - WEB_PORT=8080
    ports:
      - "8082:8080"
    volumes:
      - ./detections:/output
    networks:
      - meteor-net
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # カメラ3 (10.0.1.11)
  camera3:
    build:
      context: .
      args:
        MASK_IMAGE: masks/camera3_mask.png
    container_name: meteor-camera3
    restart: unless-stopped
    environment:
      - TZ=Asia/Tokyo
      - RTSP_URL=rtsp://6199:4003@10.0.1.11/live
      - CAMERA_NAME=camera3_10_0_1_11
      - SENSITIVITY=medium
      - SCALE=0.5
      - BUFFER=15
      - EXCLUDE_BOTTOM=0.0625
      - EXTRACT_CLIPS=true
      - LATITUDE=35.3606
      - LONGITUDE=138.7274
      - TIMEZONE=Asia/Tokyo
      - ENABLE_TIME_WINDOW=true
      - MASK_IMAGE=/app/mask_image.png
      - MASK_DILATE=5
      - MASK_SAVE=
      - WEB_PORT=8080
    ports:
      - "8083:8080"
    volumes:
      - ./detections:/output
    networks:
      - meteor-net
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  meteor-net:
    driver: bridge
