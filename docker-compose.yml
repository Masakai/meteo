# 流星検出 Docker Compose設定（Webプレビュー付き）
#
# Copyright (c) 2026 Masanori Sakai
# All rights reserved.
#
# 使い方:
#   起動:     docker compose up -d
#   停止:     docker compose down
#   ログ確認: docker compose logs -f
#
# ダッシュボード（全カメラ一覧）:
#   http://localhost:8080/
#
# 個別カメラ:
#   カメラ1: http://localhost:8081/
#   カメラ2: http://localhost:8082/
#   カメラ3: http://localhost:8083/

services:
  # ダッシュボード（全カメラ一覧）
  dashboard:
    build:
      context: .
      dockerfile: Dockerfile.dashboard
    container_name: meteor-dashboard
    restart: unless-stopped
    environment:
      - PORT=8080
      # ブラウザからアクセスするURL（localhost経由）
      - CAMERA1_NAME=camera1 (10.0.1.25)
      - CAMERA1_URL=http://localhost:8081
      - CAMERA2_NAME=camera2 (10.0.1.3)
      - CAMERA2_URL=http://localhost:8082
      - CAMERA3_NAME=camera3 (10.0.1.11)
      - CAMERA3_URL=http://localhost:8083
    ports:
      - "8080:8080"
    volumes:
      - ./detections:/output:ro
    networks:
      - meteor-net
    depends_on:
      - camera1
      - camera2
      - camera3

  # カメラ1 (10.0.1.25)
  camera1:
    build: .
    container_name: meteor-camera1
    restart: unless-stopped
    environment:
      - RTSP_URL=rtsp://6199:4003@10.0.1.25/live
      - CAMERA_NAME=camera1_10.0.1.25
      - SENSITIVITY=medium
      - SCALE=0.5
      - BUFFER=15
      - EXCLUDE_BOTTOM=0.0625
      - WEB_PORT=8080
    ports:
      - "8081:8080"
    volumes:
      - ./detections:/output
    networks:
      - meteor-net
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # カメラ2 (10.0.1.3)
  camera2:
    build: .
    container_name: meteor-camera2
    restart: unless-stopped
    environment:
      - RTSP_URL=rtsp://6199:4003@10.0.1.3/live
      - CAMERA_NAME=camera2_10.0.1.3
      - SENSITIVITY=medium
      - SCALE=0.5
      - BUFFER=15
      - EXCLUDE_BOTTOM=0.0625
      - WEB_PORT=8080
    ports:
      - "8082:8080"
    volumes:
      - ./detections:/output
    networks:
      - meteor-net
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # カメラ3 (10.0.1.11)
  camera3:
    build: .
    container_name: meteor-camera3
    restart: unless-stopped
    environment:
      - RTSP_URL=rtsp://6199:4003@10.0.1.11/live
      - CAMERA_NAME=camera3_10.0.1.11
      - SENSITIVITY=medium
      - SCALE=0.5
      - BUFFER=15
      - EXCLUDE_BOTTOM=0.0625
      - WEB_PORT=8080
    ports:
      - "8083:8080"
    volumes:
      - ./detections:/output
    networks:
      - meteor-net
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  meteor-net:
    driver: bridge
